# Copyright 2022 The HuggingFace Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Lint as: python3
import unittest

import numpy as np
import pyvista as pv

import simenv as sm


# fmt: off
class ObjectsTest(unittest.TestCase):
    def test_create_asset(self):
        asset = sm.Object3D(name="object")

        self.assertEqual(len(asset.mesh.points), 0)
        self.assertTupleEqual(asset.mesh.points.shape, (0, 3))

        self.assertListEqual(asset.material.base_color, [1.0, 1.0, 1.0, 1.0])

        self.assertIsNone(asset.collider)

        with self.assertRaises(ValueError):
            asset.plot()  # Cannot plot empty meshes

    def test_plane(self):
        asset = sm.Plane()
        dafault_mesh = np.array([[ 5.000000e+00,  0, -5.000000e+00],
                 [-5.000000e+00, -0, -5.000000e+00],
                 [ 5.000000e+00,  0,  5.000000e+00],
                 [-5.000000e+00, -0,  5.000000e+00]])
        np.testing.assert_allclose(asset.mesh.points, dafault_mesh, atol=1e-5)

    def test_sphere(self):
        asset = sm.Sphere(theta_resolution=5, phi_resolution=5)
        default_faces = np.array([ 3,  2,  5,  0,  3, 34,  8, 17,  3, 43, 11, 18,  3, 52, 14, 19,  3,
                61, 25, 20,  3,  4,  1,  7,  3, 40, 21, 10,  3, 49, 22, 13,  3, 58,
                23, 16,  3, 67, 24, 31,  4, 26,  3,  6, 35,  4, 28, 32, 41, 37,  4,
                36, 38,  9, 44,  4, 39, 42, 50, 46,  4, 45, 47, 12, 53,  4, 48, 51,
                59, 55,  4, 54, 56, 15, 62,  4, 57, 60, 68, 64,  4, 63, 65, 29, 27,
                    4, 66, 69, 33, 30])
        np.testing.assert_allclose(asset.mesh.faces, default_faces, atol=1e-5)

        dafault_mesh = np.array([[ 1.1102230e-16, -1.0000000e+00,  0.0000000e+00],
                 [-1.1102230e-16,  1.0000000e+00,  0.0000000e+00],
                 [ 7.0710677e-01, -7.0710677e-01,  0.0000000e+00],
                 [ 1.0000000e+00,  4.9789960e-17,  0.0000000e+00],
                 [ 7.0710677e-01,  7.0710677e-01,  0.0000000e+00],
                 [ 2.1850801e-01, -7.0710677e-01,  6.7249852e-01],
                 [ 3.0901700e-01, -2.6924564e-17,  9.5105654e-01],
                 [ 2.1850801e-01,  7.0710677e-01,  6.7249852e-01],
                 [-5.7206142e-01, -7.0710677e-01,  4.1562694e-01],
                 [-8.0901700e-01, -1.5105128e-16,  5.8778524e-01],
                 [-5.7206142e-01,  7.0710677e-01,  4.1562694e-01],
                 [-5.7206142e-01, -7.0710677e-01, -4.1562694e-01],
                 [-8.0901700e-01, -1.5105128e-16, -5.8778524e-01],
                 [-5.7206142e-01,  7.0710677e-01, -4.1562694e-01],
                 [ 2.1850801e-01, -7.0710677e-01, -6.7249852e-01],
                 [ 3.0901700e-01, -2.6924564e-17, -9.5105654e-01],
                 [ 2.1850801e-01,  7.0710677e-01, -6.7249852e-01],
                 [ 1.1102230e-16, -1.0000000e+00,  0.0000000e+00],
                 [ 1.1102230e-16, -1.0000000e+00,  0.0000000e+00],
                 [ 1.1102230e-16, -1.0000000e+00,  0.0000000e+00]])
        np.testing.assert_allclose(asset.mesh.points[:20], dafault_mesh, atol=1e-5)

        self.assertIsNotNone(asset.collider)
        self.assertEqual(asset.collider.type, sm.ColliderType.SPHERE)
        self.assertTupleEqual(asset.collider.bounding_box, (1.0, 1.0, 1.0))
    

    def test_capsule(self):
        asset = sm.Capsule(theta_resolution=5, phi_resolution=5)
        default_faces = np.array([ 3,  0,  1,  7,  3,  0,  7, 13,  3,  0, 13, 19,  3,  0, 19, 25,  3,
        0, 25, 31,  3,  0, 31, 37,  3,  0, 37, 43,  3,  6, 49, 12,  3, 12,
       49, 18,  3, 18, 49, 24,  3, 24, 49, 30,  3, 30, 49, 36,  3, 36, 49,
       42,  3, 42, 49, 48,  3, 57, 51, 50,  3, 63, 57, 50,  3, 69, 63, 50,
        3, 75, 69, 50,  3, 81, 75, 50,  3, 87, 81, 50,  3, 93, 87, 50,  3,
       56, 62, 99,  3, 62, 68, 99,  3, 68, 74, 99,  3, 74, 80, 99,  3, 80,
       86, 99,  3, 86, 92, 99,  3, 92, 98, 99,  4,  1,  2,  8,  7,  4, 51,
       57, 58, 52,  4,  2,  3,  9,  8,  4, 52, 58, 59, 53,  4,  3,  4, 10,
        9,  4, 53, 59, 60, 54,  4,  4,  5, 11, 10,  4, 54, 60, 61, 55,  4,
        5,  6, 12, 11,  4, 55, 61, 62, 56,  4,  7,  8, 14, 13,  4, 57, 63,
       64, 58,  4,  8,  9, 15, 14,  4, 58, 64, 65, 59,  4,  9, 10, 16, 15,
        4, 59, 65, 66, 60,  4, 10, 11, 17, 16,  4, 60, 66, 67, 61,  4, 11,
       12, 18, 17,  4, 61, 67, 68, 62,  4, 13, 14, 20, 19,  4, 63, 69, 70,
       64,  4, 14, 15, 21, 20,  4, 64, 70, 71, 65,  4, 15, 16, 22, 21,  4,
       65, 71, 72, 66,  4, 16, 17, 23, 22,  4, 66, 72, 73, 67,  4, 17, 18,
       24, 23,  4, 67, 73, 74, 68,  4, 19, 20, 26, 25,  4, 69, 75, 76, 70,
        4, 20, 21, 27, 26,  4, 70, 76, 77, 71,  4, 21, 22, 28, 27,  4, 71,
       77, 78, 72,  4, 22, 23, 29, 28,  4, 72, 78, 79, 73,  4, 23, 24, 30,
       29,  4, 73, 79, 80, 74,  4, 25, 26, 32, 31,  4, 75, 81, 82, 76,  4,
       26, 27, 33, 32,  4, 76, 82, 83, 77,  4, 27, 28, 34, 33,  4, 77, 83,
       84, 78,  4, 28, 29, 35, 34,  4, 78, 84, 85, 79,  4, 29, 30, 36, 35,
        4, 79, 85, 86, 80,  4, 31, 32, 38, 37,  4, 81, 87, 88, 82,  4, 32,
       33, 39, 38,  4, 82, 88, 89, 83,  4, 33, 34, 40, 39,  4, 83, 89, 90,
       84,  4, 34, 35, 41, 40,  4, 84, 90, 91, 85,  4, 35, 36, 42, 41,  4,
       85, 91, 92, 86,  4, 37, 38, 44, 43,  4, 87, 93, 94, 88,  4, 38, 39,
       45, 44,  4, 88, 94, 95, 89,  4, 39, 40, 46, 45,  4, 89, 95, 96, 90,
        4, 40, 41, 47, 46,  4, 90, 96, 97, 91,  4, 41, 42, 48, 47,  4, 91,
       97, 98, 92,  3,  0, 50,  1,  3,  1, 50, 51,  3,  1, 51,  2,  3,  2,
       51, 52,  3,  2, 52,  3,  3,  3, 52, 53,  3,  3, 53,  4,  3,  4, 53,
       54,  3,  4, 54,  5,  3,  5, 54, 55,  3,  5, 55,  6,  3,  6, 55, 56,
        3, 49, 99, 48,  3, 48, 99, 98,  3, 48, 98, 47,  3, 47, 98, 97,  3,
       47, 97, 46,  3, 46, 97, 96,  3, 46, 96, 45,  3, 45, 96, 95,  3, 45,
       95, 44,  3, 44, 95, 94,  3, 44, 94, 43,  3, 43, 94, 93,  4,  6, 56,
       99, 49,  4, 43, 93, 50,  0])
        np.testing.assert_allclose(asset.mesh.faces, default_faces, atol=1e-5)

        dafault_mesh = np.array([[ 2.0000000e-01,  3.0000001e-01,  3.3306692e-17],
                 [ 1.8019377e-01,  3.0000001e-01, -8.6776748e-02],
                 [ 1.2469796e-01,  3.0000001e-01, -1.5636630e-01],
                 [ 4.4504188e-02,  3.0000001e-01, -1.9498558e-01],
                 [-4.4504188e-02,  3.0000001e-01, -1.9498558e-01],
                 [-1.2469796e-01,  3.0000001e-01, -1.5636630e-01],
                 [-1.8019377e-01,  3.0000001e-01, -8.6776748e-02],
                 [ 1.8019377e-01,  3.3765101e-01, -7.8183152e-02],
                 [ 1.2469796e-01,  3.6784479e-01, -1.4088117e-01],
                 [ 4.4504188e-02,  3.8460109e-01, -1.7567594e-01],
                 [-4.4504188e-02,  3.8460109e-01, -1.7567594e-01],
                 [-1.2469796e-01,  3.6784479e-01, -1.4088117e-01],
                 [-1.8019377e-01,  3.3765101e-01, -7.8183152e-02],
                 [ 1.8019377e-01,  3.6784479e-01, -5.4104418e-02],
                 [ 1.2469796e-01,  4.2225209e-01, -9.7492792e-02],
                 [ 4.4504188e-02,  4.5244586e-01, -1.2157152e-01],
                 [-4.4504188e-02,  4.5244586e-01, -1.2157152e-01],
                 [-1.2469796e-01,  4.2225209e-01, -9.7492792e-02],
                 [-1.8019377e-01,  3.6784479e-01, -5.4104418e-02],
                 [ 1.8019377e-01,  3.8460109e-01, -1.9309644e-02]])
        np.testing.assert_allclose(asset.mesh.points[:20], dafault_mesh, atol=1e-5)

        self.assertIsNotNone(asset.collider)
        self.assertEqual(asset.collider.type, sm.ColliderType.CAPSULE)
        self.assertTupleEqual(asset.collider.bounding_box, (0.2, 1.0, 0.2))

    def test_cylinder(self):
        asset = sm.Cylinder(resolution=5)
        default_faces = np.array([ 4,  0,  1,  3,  2,  4, 22, 23,  5,  4,  4, 24, 25,  7,  6,  4, 26,
            27,  9,  8,  4, 28, 29, 21, 20,  5, 10, 11, 12, 13, 14,  5, 15, 16,
            17, 18, 19])
        np.testing.assert_allclose(asset.mesh.faces, default_faces, atol=1e-5)

        dafault_mesh = np.array([[ 0.        ,  0.5       , -1.        ],
                 [ 0.        , -0.5       , -1.        ],
                 [-0.95105654,  0.5       , -0.309017  ],
                 [-0.95105654, -0.5       , -0.309017  ],
                 [-0.58778524,  0.5       ,  0.809017  ],
                 [-0.58778524, -0.5       ,  0.809017  ],
                 [ 0.58778524,  0.5       ,  0.809017  ],
                 [ 0.58778524, -0.5       ,  0.809017  ],
                 [ 0.95105654,  0.5       , -0.309017  ],
                 [ 0.95105654, -0.5       , -0.309017  ],
                 [ 0.        ,  0.5       , -1.        ],
                 [-0.95105654,  0.5       , -0.309017  ],
                 [-0.58778524,  0.5       ,  0.809017  ],
                 [ 0.58778524,  0.5       ,  0.809017  ],
                 [ 0.95105654,  0.5       , -0.309017  ],
                 [ 0.95105654, -0.5       , -0.309017  ],
                 [ 0.58778524, -0.5       ,  0.809017  ],
                 [-0.58778524, -0.5       ,  0.809017  ],
                 [-0.95105654, -0.5       , -0.309017  ],
                 [ 0.        , -0.5       , -1.        ]])
        np.testing.assert_allclose(asset.mesh.points[:20], dafault_mesh, atol=1e-5)

        self.assertIsNone(asset.collider)

    def test_box(self):
        asset = sm.Box()
        default_faces = np.array([ 4,  0,  4,  6,  2,  4,  5,  1,  3,  7,  4,  8, 10, 18, 16,  4, 20,
       22, 14, 12,  4, 11,  9, 13, 15,  4, 17, 19, 23, 21])
        np.testing.assert_allclose(asset.mesh.faces, default_faces, atol=1e-5)

        dafault_mesh = np.array([[-0.5, -0.5, -0.5],
                 [ 0.5, -0.5, -0.5],
                 [-0.5,  0.5, -0.5],
                 [ 0.5,  0.5, -0.5],
                 [-0.5, -0.5,  0.5],
                 [ 0.5, -0.5,  0.5],
                 [-0.5,  0.5,  0.5],
                 [ 0.5,  0.5,  0.5],
                 [-0.5, -0.5, -0.5],
                 [-0.5, -0.5, -0.5],
                 [ 0.5, -0.5, -0.5],
                 [ 0.5, -0.5, -0.5],
                 [-0.5,  0.5, -0.5],
                 [-0.5,  0.5, -0.5],
                 [ 0.5,  0.5, -0.5],
                 [ 0.5,  0.5, -0.5],
                 [-0.5, -0.5,  0.5],
                 [-0.5, -0.5,  0.5],
                 [ 0.5, -0.5,  0.5],
                 [ 0.5, -0.5,  0.5]])
        np.testing.assert_allclose(asset.mesh.points[:20], dafault_mesh, atol=1e-5)

        self.assertIsNotNone(asset.collider)
        self.assertEqual(asset.collider.type, sm.ColliderType.BOX)
        self.assertTupleEqual(asset.collider.bounding_box, (1.0, 1.0, 1.0))

    def test_cone(self):
        asset = sm.Cone()
        default_faces = np.array([ 6,  6,  5,  4,  3,  2,  1,  3,  0, 12, 14,  3,  7, 15, 16,  3,  8,
       17, 18,  3,  9, 19, 20,  3, 10, 21, 22,  3, 11, 23, 13])
        np.testing.assert_allclose(asset.mesh.faces, default_faces, atol=1e-5)

        dafault_mesh = np.array([[ 0.0000000e+00,  5.0000000e-01, -4.3297803e-17],
                 [ 1.0000000e+00, -5.0000000e-01,  1.2989340e-16],
                 [ 5.0000000e-01, -5.0000000e-01, -8.6602539e-01],
                 [-5.0000000e-01, -5.0000000e-01, -8.6602539e-01],
                 [-1.0000000e+00, -5.0000000e-01, -1.6576248e-16],
                 [-5.0000000e-01, -5.0000000e-01,  8.6602539e-01],
                 [ 5.0000000e-01, -5.0000000e-01,  8.6602539e-01],
                 [ 0.0000000e+00,  5.0000000e-01, -4.3297803e-17],
                 [ 0.0000000e+00,  5.0000000e-01, -4.3297803e-17],
                 [ 0.0000000e+00,  5.0000000e-01, -4.3297803e-17],
                 [ 0.0000000e+00,  5.0000000e-01, -4.3297803e-17],
                 [ 0.0000000e+00,  5.0000000e-01, -4.3297803e-17],
                 [ 1.0000000e+00, -5.0000000e-01,  1.2989340e-16],
                 [ 1.0000000e+00, -5.0000000e-01,  1.2989340e-16],
                 [ 5.0000000e-01, -5.0000000e-01, -8.6602539e-01],
                 [ 5.0000000e-01, -5.0000000e-01, -8.6602539e-01],
                 [-5.0000000e-01, -5.0000000e-01, -8.6602539e-01],
                 [-5.0000000e-01, -5.0000000e-01, -8.6602539e-01],
                 [-1.0000000e+00, -5.0000000e-01, -1.6576248e-16],
                 [-1.0000000e+00, -5.0000000e-01, -1.6576248e-16]])
        np.testing.assert_allclose(asset.mesh.points[:20], dafault_mesh, atol=1e-5)

        self.assertIsNone(asset.collider)

    def test_line(self):
        asset = sm.Line()
        default_faces = np.array([])
        np.testing.assert_allclose(asset.mesh.faces, default_faces, atol=1e-5)

        dafault_mesh = np.array([[-1.,  0.,  0.],
                 [ 1.,  0.,  0.]])
        np.testing.assert_allclose(asset.mesh.points[:20], dafault_mesh, atol=1e-5)

        self.assertIsNone(asset.collider)

    def test_multiplelines(self):
        asset = sm.MultipleLines()
        default_faces = np.array([])
        np.testing.assert_allclose(asset.mesh.faces, default_faces, atol=1e-5)

        dafault_mesh = np.array([[-1.,  0.,  0.],
                 [ 1.,  0.,  0.]])
        np.testing.assert_allclose(asset.mesh.points[:20], dafault_mesh, atol=1e-5)

        self.assertIsNone(asset.collider)

    def test_tube(self):
        asset = sm.Tube()
        default_faces = np.array([ 3,  1,  0, 17,  3, 17,  0, 16,  3,  2,  1, 18,  3, 18,  1, 17,  3,
        3,  2, 19,  3, 19,  2, 18,  3,  4,  3, 20,  3, 20,  3, 19,  3,  5,
        4, 21,  3, 21,  4, 20,  3,  6,  5, 22,  3, 22,  5, 21,  3,  7,  6,
       23,  3, 23,  6, 22,  3,  8,  7, 24,  3, 24,  7, 23,  3,  9,  8, 25,
        3, 25,  8, 24,  3, 10,  9, 26,  3, 26,  9, 25,  3, 11, 10, 27,  3,
       27, 10, 26,  3, 12, 11, 28,  3, 28, 11, 27,  3, 13, 12, 29,  3, 29,
       12, 28,  3, 14, 13, 30,  3, 30, 13, 29,  3, 15, 14, 31,  3, 31, 14,
       30,  3,  0, 15, 16,  3, 16, 15, 31])
        np.testing.assert_allclose(asset.mesh.faces, default_faces, atol=1e-5)

        dafault_mesh = np.array([[-1.0000000e+00,  0.0000000e+00,  1.0000000e+00],
                 [-1.0000000e+00,  3.8268343e-01,  9.2387950e-01],
                 [-1.0000000e+00,  7.0710677e-01,  7.0710677e-01],
                 [-1.0000000e+00,  9.2387950e-01,  3.8268343e-01],
                 [-1.0000000e+00,  1.0000000e+00,  6.1232343e-17],
                 [-1.0000000e+00,  9.2387950e-01, -3.8268343e-01],
                 [-1.0000000e+00,  7.0710677e-01, -7.0710677e-01],
                 [-1.0000000e+00,  3.8268343e-01, -9.2387950e-01],
                 [-1.0000000e+00,  1.2246469e-16, -1.0000000e+00],
                 [-1.0000000e+00, -3.8268343e-01, -9.2387950e-01],
                 [-1.0000000e+00, -7.0710677e-01, -7.0710677e-01],
                 [-1.0000000e+00, -9.2387950e-01, -3.8268343e-01],
                 [-1.0000000e+00, -1.0000000e+00, -1.8369701e-16],
                 [-1.0000000e+00, -9.2387950e-01,  3.8268343e-01],
                 [-1.0000000e+00, -7.0710677e-01,  7.0710677e-01],
                 [-1.0000000e+00, -3.8268343e-01,  9.2387950e-01],
                 [ 1.0000000e+00,  0.0000000e+00,  1.0000000e+00],
                 [ 1.0000000e+00,  3.8268343e-01,  9.2387950e-01],
                 [ 1.0000000e+00,  7.0710677e-01,  7.0710677e-01],
                 [ 1.0000000e+00,  9.2387950e-01,  3.8268343e-01]])
        np.testing.assert_allclose(asset.mesh.points[:20], dafault_mesh, atol=1e-5)

        self.assertIsNone(asset.collider)

    def test_polygon(self):
        asset = sm.Polygon()
        default_faces = np.array([ 3,  1,  0, 17,  3, 17,  0, 16,  3,  2,  1, 18,  3, 18,  1, 17,  3,
        3,  2, 19,  3, 19,  2, 18,  3,  4,  3, 20,  3, 20,  3, 19,  3,  5,
        4, 21,  3, 21,  4, 20,  3,  6,  5, 22,  3, 22,  5, 21,  3,  7,  6,
       23,  3, 23,  6, 22,  3,  8,  7, 24,  3, 24,  7, 23,  3,  9,  8, 25,
        3, 25,  8, 24,  3, 10,  9, 26,  3, 26,  9, 25,  3, 11, 10, 27,  3,
       27, 10, 26,  3, 12, 11, 28,  3, 28, 11, 27,  3, 13, 12, 29,  3, 29,
       12, 28,  3, 14, 13, 30,  3, 30, 13, 29,  3, 15, 14, 31,  3, 31, 14,
       30,  3,  0, 15, 16,  3, 16, 15, 31])
        np.testing.assert_allclose(asset.mesh.faces, default_faces, atol=1e-5)

        dafault_mesh = np.array([[-1.0000000e+00,  0.0000000e+00,  1.0000000e+00],
                 [-1.0000000e+00,  3.8268343e-01,  9.2387950e-01],
                 [-1.0000000e+00,  7.0710677e-01,  7.0710677e-01],
                 [-1.0000000e+00,  9.2387950e-01,  3.8268343e-01],
                 [-1.0000000e+00,  1.0000000e+00,  6.1232343e-17],
                 [-1.0000000e+00,  9.2387950e-01, -3.8268343e-01],
                 [-1.0000000e+00,  7.0710677e-01, -7.0710677e-01],
                 [-1.0000000e+00,  3.8268343e-01, -9.2387950e-01],
                 [-1.0000000e+00,  1.2246469e-16, -1.0000000e+00],
                 [-1.0000000e+00, -3.8268343e-01, -9.2387950e-01],
                 [-1.0000000e+00, -7.0710677e-01, -7.0710677e-01],
                 [-1.0000000e+00, -9.2387950e-01, -3.8268343e-01],
                 [-1.0000000e+00, -1.0000000e+00, -1.8369701e-16],
                 [-1.0000000e+00, -9.2387950e-01,  3.8268343e-01],
                 [-1.0000000e+00, -7.0710677e-01,  7.0710677e-01],
                 [-1.0000000e+00, -3.8268343e-01,  9.2387950e-01],
                 [ 1.0000000e+00,  0.0000000e+00,  1.0000000e+00],
                 [ 1.0000000e+00,  3.8268343e-01,  9.2387950e-01],
                 [ 1.0000000e+00,  7.0710677e-01,  7.0710677e-01],
                 [ 1.0000000e+00,  9.2387950e-01,  3.8268343e-01]])
        np.testing.assert_allclose(asset.mesh.points[:20], dafault_mesh, atol=1e-5)

        self.assertIsNone(asset.collider)

# fmt: on
